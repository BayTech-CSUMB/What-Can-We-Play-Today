<%- include('partials/header.ejs') %> 
<%- include('partials/navbar.ejs') %> 
<%- include('partials/tempNav.ejs') %>

<div id="toGrab"></div>

<hr/>

<div id="recGames"></div>

<body onload="sendMessage()"></body>

<script>
    let hasReceivedGames = false;
    
  const socket = io("<%= url %>");

  socket.on("connection");

  const sendMessage = () => {
    let temp = [];

    let steamID = Cookies.get("steamID");
    let username = Cookies.get("username");
    let avatar = Cookies.get("avatar");
    let roomNumber = Cookies.get("roomNumber");
    
    socket.emit("generate", {
      steamID: steamID,
      username: username,
      avatar: avatar,
      roomNumber: roomNumber
    });

    socket.on("finalList", (data) => {
      let roomMembers = data.roomMembers;
      let sharedGameNames = data.games;
      let ownedByWho = data.owners;

      function invertOwners(someArr) {
        let temp = [];
        for (let i = 0; i < roomMembers.length; i++) {
          temp.push(i);
        }
        return filterOut(temp, someArr);
      }

      function convertToUser(someArr) {
        let temp = ``;
        for (let i = 0; i < someArr.length; i++) {
          temp += `${roomMembers[someArr[i]][1]} `;
        }
        return temp;
      }

      function filterOut(arr1, arr2) {
        const result = arr1.filter((x) => arr2.indexOf(x) == -1);
        return result;
      }

      let suggestDiv = document.getElementById("toGrab");
      let recommendDiv = document.querySelector("#recGames");

    // This IF is a workaround to ensure we don't get DUPLICATE games in our list. 
      if ((suggestDiv.childNodes.length === 0) && (recommendDiv.childNodes.length === 0)) {
      for (let i = 0; i < sharedGameNames.length; i++) {
        if (ownedByWho[i].length != roomMembers.length) {
          let users = convertToUser(invertOwners(ownedByWho[i]));
          // let users = invertOwners(ownedByWho[i]);
          recommendDiv.innerHTML += `<p style='color: white;'>${sharedGameNames[i]} is NOT owned by ${users} </p>`;
          // console.log(`${sharedGameNames[i]} is NOT owned by ${users}`);
        } else {
          // Case for ALL owned
          suggestDiv.innerHTML += `<p style='color: white;'>${sharedGameNames[i]}</p>`;
        }
      }
    }
    });
  };
</script>
